#!/bin/bash

# UPDATED FOE NEW GridEngine
# USAGE
# subcheck dirname programname [slow/fast]
#
# Output and error are put into dirname

. /usr/local/bin/GridEngine/default/common/settings.sh


# Configurable parameters
MAXNUMBER=50
MAXNUMBERUSER=40
SLEEPTIME=200
SLEEPLONG=500

SUCCESS=0
until [ $SUCCESS -eq 1 ]; do
  NUMBER_U=`qstat -u "*"|grep -c $USER`
  NUMBER_S=`qstat -u "*"|grep -c all.q`
#  echo $NUMBER_U "job submitted by" $USER
#  echo $NUMBER_S " slow job in the queues"
  if [ $NUMBER_U -lt $MAXNUMBERUSER ]; then
    if [ "$3" = "slow" ]; then
      if [ $NUMBER_S -lt $MAXNUMBER ]; then
        if [ "$4" != "" ]; then
          qsub -q all.q@$4 -o $1 -e $1 $1/$2
        else
          qsub -q all.q -o $1 -e $1 $1/$2
	fi
        SUCCESS=1
# In order to have enough time for the slow job to appear as such in qstat
        sleep 20
      else
        sleep $SLEEPTIME
      fi 
    elif [ "$3" = "fast" ]; then
      if [ "$4" != "" ]; then
        qsub -q fast.q@$4 -o $1 -e $1 $1/$2
      else
        qsub -q fast.q -o $1 -e $1 $1/$2
      fi 
      SUCCESS=1
    else
      qsub -q all.q  -o $1 -e $1 $1/$2 
      SUCCESS=1
    fi
#    echo `qstat|grep -c $USER`
  else
#    date
    sleep $SLEEPLONG
  fi
done

